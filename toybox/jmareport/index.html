<!DOCTYPE html>

<html lang="ja">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />

  <link href="../../css/bootstrap.min.css" rel="stylesheet" />
  <link href="../../css/my.css" rel="stylesheet" />

  <title>meteorological report</title>
</head>

<body>

  <div class="container">
    <div class="page-header">
      <h1>meteorological report.</h1>
    </div>
    <div id="main-container" class="my-margin">
      <div class="row">
        <div class="col-md-12">
          <h4>report visual</h4>
          <div id="svg-area"></div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <h4>event message</h4>
          <pre id="event-message" class="message">
            message here.
          </pre>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <h4>report message</h4>
          <pre id="report-message" class="message">
            message here.
          </pre>
        </div>
      </div>
    </div>
    <!-- main-container -->

    <hr />
    <div id="footer" class="text-center">
      copyright globy 2015.
    </div>
  </div>
  <!-- container -->


  <script src="../../js/jquery-1.11.3.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <script src="../../js/d3.js"></script>
  <script src="../../js/topojson.js"></script>
  <script>
    var AREA_MARGIN = {
      TOP: 10,
      RIGHT: 10,
      BOTTOM: 10,
      LEFT: 10
    }
    var AREA = {
      W: 600,
      H: 600 - (AREA_MARGIN.TOP + AREA_MARGIN.BOTTOM)
    };

    var svg;
    var scale = 600; // default
    var geoJp;


    d3.json("japan_topojson.json", function(error, jpdata) {
      if (error != null) {
        console.log(err);
        return;
      }
      console.log(jpdata);

      geoJp = topojson.feature(jpdata, jpdata.objects.ne_10m_admin_1_states_provinces);
      console.log(geoJp);

      svg = setupGraphArea();
      drawGeoJp();
      drawGeoObservatory();

    });


    /**
     *
     */
    function setupGraphArea() {
      console.log("start function setupGraphArea.");

      var svg = d3.select("#svg-area").append("svg");
      svg.attr({
        "id": "svg",
        "preserveAspectRatio": "none",
        "viewBox": "0 0 " + AREA.W + " " + AREA.H
      });
      svg.append("g").attr("id", "geojp");
      svg.append("g").attr("id", "geoobs");
      svg.append("g").attr("id", "georepo");


      projection = d3.geo.mercator()
        .center([136.0, 35.6])
        .translate([AREA.W / 2, AREA.H / 2])
        .scale(scale);

      geopath = d3.geo.path()
        .projection(projection);

      var zoom = d3.behavior.zoom()
        .on("zoom", zoomMap);
      svg.call(zoom);

      var drag = d3.behavior.drag()
        .on("drag", dragMap);
      svg.call(drag);

      console.log("end function setupGraphArea.");
      return svg;
    }


    /**
     *
     */
    function drawGeoJp() {

      svg.select("g#geojp").selectAll("path")
        .data(geoJp.features) // geojsonのすべての県の座標データを読み込む。
        .enter()
        .append("path")
        .attr("class", function(d) {
          return d.id;
        })
        .attr("d", geopath); // geojsonからpath要素に変換する。
      // .attr("fill", function(d) {
      //   return color(d.geometry.coordinates);
      // }); // idがないので、各県の座標リストに基づいて色を変える。

    }


    /**
     *
     */
    function drawGeoObservatory() {
      console.log("call drawGeoObservatory");

      var data;

      d3.json("observatory_geo.json", function(error, obsdata) {
        console.log(error);
        console.log(obsdata);

        data = obsdata;

        svg.select("g#geoobs").selectAll("circle")
          .data(data.features)
          .enter()
          .append("circle")
          .attr({
            "r": 2,
            "transform": function(d) {
              /*whatever transformation that needs to be done*/
              return "translate(" + projection([d.geometry.coordinates[0], d.geometry.coordinates[1]]) + ")";
            }
          })
          .style("fill", "red")
          .classed("pin", true);


      });



    }


    /**
     *
     */
    function zoomMap() {
      projection.scale(scale * d3.event.scale);
      svg.select("g#geojp").selectAll("path").attr("d", geopath);
      svg.select("g#geoobs").selectAll("circle").attr("transform", function(d) {
        /*whatever transformation that needs to be done*/
        return "translate(" + projection([d.geometry.coordinates[0], d.geometry.coordinates[1]]) + ")";
      });
    }


    /**
     *
     */
    function dragMap() {
      var tl = projection.translate();
      projection.translate([tl[0] + d3.event.dx, tl[1] + d3.event.dy]);
      svg.select("g#geojp").selectAll("path").attr("d", geopath);
      svg.select("g#geoobs").selectAll("circle").attr("transform", function(d) {
        /*whatever transformation that needs to be done*/
        return "translate(" + projection([d.geometry.coordinates[0], d.geometry.coordinates[1]]) + ")";
      });
    }
  </script>
</body>

</html>
