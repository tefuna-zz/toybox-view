<!DOCTYPE html>

<html lang="ja">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />

  <link href="../../css/bootstrap.min.css" rel="stylesheet" />
  <link href="../../css/my.css" rel="stylesheet" />

  <title>mail attack visualization</title>
</head>

<body>

  <div class="container">
    <div class="page-header">
      <h1>mail attack visualization.</h1>
    </div>

    <div id="div-request-area">
      <h2>setup</h2>
      <div class="my-margin">
        <form class="form-inline">
          <div class="form-group">
            <label class="control-label">attack from - to</label>
            <input type="text" class="form-control" placeholder="from: yyyymmdd" />
            <input type="text" class="form-control" placeholder="to: yyyymmdd" />
          </div>
          <button type="submit" class="btn btn-primary">execute</button>
          <button type="reset" class="btn btn-default">reset</button>
        </form>
      </div>
    </div>
    <!-- div-request-area -->
    <br />

    <hr />
    <div id="div-result-area">
      <h2>result</h2>
      <div id="result" class="my-margin">
        <div class="row">
          <div class="col-sm-2">
            <span class="label label-default label-my">attack from - to</span>
          </div>
          <p id="txt-attack-from-to" class="col-sm-2">yyyymmdd - yyyymmdd</p>

          <div class="col-sm-1">
            <span class="label label-default label-my">node count</span>
          </div>
          <p id="txt-node-count" class="col-sm-1">9</p>

          <div class="col-sm-1">
            <span class="label label-default label-my">mail count</span>
          </div>
          <p id="txt-mail-count" class="col-sm-1">99</p>
        </div>
        <button class="btn btn-primary col-sm-1" onclick="addLink()">start</button>

      </div>
      <!-- result -->

      <br />

      <div id="result-image" class="my-margin"> </div>
      <!-- result-image -->


    </div>
    <!-- div-result-area -->
  </div>
  <!-- container -->


  <script src="../../js/jquery-1.11.3.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <script src="../../js/d3.js"></script>
  <script src="js/ma-common.js"></script>

  <script>
    var AREA_W = 800;
    var AREA_H = 600;
    var AREA_PAD = 30;

    var dataset;
    var svg;
    var force;
    var nodes;
    var links;
    var count = 0;
    var path;
    var node;
    var nodeWeight = [];
    var linkWeight = [];

    /**
     * read json file.
     */
    d3.json("data.json", function(error, jsondata) {
      console.log(error);
      console.log(jsondata);
      dataset = jsondata;

      $("#txt-attack-from-to").text(dataset.date.from + " - " + dataset.date.to);
      $("#txt-node-count").text(dataset.node.length);
      $("#txt-mail-count").text(dataset.mail.length);

      for (var i = 0; i< dataset.node.length; i++) {
        var obj = {id: dataset.node[i].id, wt: 1};
        nodeWeight.push(obj);
      }


      svg = setupGraphArea();
      update();
    });


    /**
     *
     */
    function setupGraphArea() {
      console.log("start function setupGraphArea.");

      var svg = d3.select("#result-image").append("svg");
      svg.attr({
        width: AREA_W,
        height: AREA_H
      });

      svg.append("defs").selectAll("marker")
        .data(["end"]) // Different link/path types can be defined here
        .enter()
        .append("svg:marker") // This section adds in the arrows
        .attr("id", String)
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 15)
        .attr("refY", -1.5)
        .attr("markerWidth", 6)
        .attr("markerHeight", 6)
        .attr("orient", "auto")
        .append("svg:path")
        .attr("d", "M0,-5L10,0L0,5");
      svg.append("g").attr("class", "data");

      force = d3.layout.force();
      force.nodes(dataset.node);
      nodes = force.nodes();
      links = force.links();

      console.log("end function setupGraphArea.");

      return svg;
    }

    /**
     *
     */
    function addLink() {
      console.log("start function addLink");

      var link = dataset.link[count];
      // for (var i = 0; i < linkWeight.length; i++) {
      //     if (link.id = linkWeight[i].id) {
      //       link.wt = link.wt + linkWeight[i].wt;
      //       break;
      //     }
      // }
      //
      // var obj = {id : link}
      // linkWeight.push(link);
      links.push(link);



      console.log(links);
      count++;

      update();
      console.log("end function addLink");
    }


    /**
     *
     */
    function update() {
      console.log("start function update.");

      path = svg.select("g.data").selectAll(".link")
        .data(links, function(d) {
          return d.id;
        });

      path.enter()
        .append("path")
        .attr({
          "id": function(d) {
            console.log($("#" + d.id));
            return d.id;
          },
          "class": "link",
          "marker-end": "url(#end)"
        });


      // update node.
      node = svg.select("g.data").selectAll(".node")
        .data(nodes, function(d) {
          return d.id;
        });

      node.enter()
        .append("g")
        .attr({
          "id": function(d) {
            return d.id;
          },
          "class": "node"
        })
        .call(force.drag);

      node.append("circle")
        .attr("r", 10);

      node.append("text")
        .attr("x", 12)
        .attr("dy", ".35em")
        .text(function(d) {
          return d.name;
        });

      // Restart the force layout.
      force
        .distance(200)
        .charge(-200)
        .linkDistance(200)
        .gravity(0)
        .size([AREA_W, AREA_H])
        .on("tick", tick)
        .start();

      console.log("end function update.");

    }


    /**
     *
     */
    function tick() {
      path.attr("d", function(d) {
        var dx = d.target.x - d.source.x,
          dy = d.target.y - d.source.y,
          dr = Math.sqrt(dx * dx + dy * dy);
        return "M" +
          d.source.x + "," +
          d.source.y + "A" +
          dr + "," + dr + " 0 0,1 " +
          d.target.x + "," +
          d.target.y;
      });

      node.attr("transform", function(d) {
        return "translate(" + d.x + "," + d.y + ")";
      });
    }
  </script>
</body>

</html>
