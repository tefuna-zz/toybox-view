<!DOCTYPE html>

<html lang="ja">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />

  <link href="../../css/bootstrap.min.css" rel="stylesheet" />
  <link href="../../css/my.css" rel="stylesheet" />

  <title>mail attack visualization</title>
</head>

<body>

  <div class="container">
    <div class="page-header">
      <h1>mail attack visualization.</h1>
    </div>

    <div id="div-request-area">
      <h2>setup</h2>
      <div class="my-margin">
        <form class="form-inline">
          <div class="form-group">
            <label class="control-label">attack from - to</label>
            <input type="text" class="form-control" placeholder="from: yyyymmdd" />
            <input type="text" class="form-control" placeholder="to: yyyymmdd" />
          </div>
          <button type="submit" class="btn btn-primary">execute</button>
          <button type="reset" class="btn btn-default">reset</button>
        </form>
      </div>
    </div>
    <!-- div-request-area -->
    <br />

    <hr />
    <div id="div-result-area">
      <h2>result</h2>
      <div id="result" class="my-margin">
        <div class="row">
          <div class="col-sm-2">
            <span class="label label-default label-my">attack from - to</span>
          </div>
          <p id="txt-attack-from-to" class="col-sm-2">yyyymmdd - yyyymmdd</p>

          <div class="col-sm-1">
            <span class="label label-default label-my">node count</span>
          </div>
          <p id="txt-node-count" class="col-sm-1">9</p>

          <div class="col-sm-1">
            <span class="label label-default label-my">mail count</span>
          </div>
          <p id="txt-mail-count" class="col-sm-1">99</p>
        </div>
        <button class="btn btn-primary col-sm-1" onclick="addLink()">start</button>

      </div>
      <!-- result -->

      <br />

      <div id="result-image" class="my-margin"> </div>
      <!-- result-image -->


    </div>
    <!-- div-result-area -->
  </div>
  <!-- container -->


  <script src="../../js/jquery-1.11.3.js"></script>
  <script src="../../js/bootstrap.min.js"></script>
  <script src="../../js/d3.js"></script>
  <script src="js/ma-common.js"></script>

  <script>
    var AREA_W = 800;
    var AREA_H = 600;
    var AREA_PAD = 30;
    var NODE_R_DEFAULT = 10;
    var NODE_R_WEIGHT = 2;
    var LINK_W_DEFAULT = 1.0;
    var LINK_W_WEIGHT = 0.2;

    var dataset;
    var svg;
    var forceLayout;
    var nodes;
    var links;
    var count = 0;
    var nodeObj;
    var linkObj;
    var nodeWeight = [];
    var linkWeight = [];

    /**
     * read json file.
     */
    d3.json("data.json", function(error, jsondata) {
      if (error != null) {
        console.log(err);
        return;
      }
      console.log(jsondata);
      dataset = jsondata;

      $("#txt-attack-from-to").text(dataset.date.from + " - " + dataset.date.to);
      $("#txt-node-count").text(dataset.node.length);
      $("#txt-mail-count").text(dataset.mail.length);

      for (var i = 0; i < dataset.node.length; i++) {
        var obj = {
          id: dataset.node[i].id,
          wt: 1
        };
        nodeWeight.push(obj);
      }

      svg = setupGraphArea();
      nodeObj = setupNode();
      update();
    });


    /**
     *
     */
    function setupGraphArea() {
      console.log("start function setupGraphArea.");

      var svg = d3.select("#result-image").append("svg");
      svg.attr({
        width: AREA_W,
        height: AREA_H
      });

      // path arrow definition.
      svg.append("defs").selectAll("marker")
        .data(["end"]) // different link/path types can be defined here
        .enter()
        .append("svg:marker") // This section adds in the arrows
        .attr({
          "id": "arrowhead",
          "viewBox": "0 -5 10 10",
          "refX": 8,
          "refY": -1.5,
          "markerWidth": 6,
          "markerHeight": 6,
          "orient": "auto"
        })
        .append("svg:path")
        .attr("d", "M0,-5L10,0L0,5");

      svg.append("g").attr("class", "data");

      // forcelayout setup.
      forceLayout = d3.layout.force();
      forceLayout.nodes(dataset.node);
      nodes = forceLayout.nodes();
      links = forceLayout.links();

      console.log("end function setupGraphArea.");

      return svg;
    }


    /**
     *
     */
    function setupNode() {
      console.log("start function setupNode.");

      node = svg.select("g.data").selectAll(".node")
        .data(nodes, function(d) {
          return d.id;
        });

      node.enter()
        .append("g")
        .attr({
          "id": function(d) {
            return d.id;
          },
          "class": "node"
        })
        .call(forceLayout.drag);

      node.append("circle")
        .attr({
          "id": function(d) {
            return "c_" + d.id;
          },
        });

      node.append("text")
        .attr({
          "id": function(d) {
            return "t_" + d.id;
          },
          "x": 12,
          "dy": ".35em"
        })
        .text(function(d) {
          return d.name;
        });


      //  sum of arrows wt.
      for (var i = 0; i < nodes.length; i++) {
        nodes[i].wtsum = 0;
      }

      console.log("end function setupNode.");

      return node
    }


    /**
     *
     */
    function addLink() {
      console.log("start function addLink");

      var link = dataset.link[count];

      // calc node weight.
      for (var i = 0; i < nodes.length; i++) {
        if (nodes[i].id == "n" + link.target) {
          nodes[i].wtsum = nodes[i].wtsum + link.wt;
          break;
        }
      }

      // calc link weight.
      var linkExist = false;
      for (var i = 0; i < links.length; i++) {
        if (links[i].source.id == "n" + link.source && links[i].target.id == "n" + link.target) {
          links[i].wtsum = links[i].wtsum + link.wt;
          linkExist = true;
          break;
        }
      }

      // add as new link.
      if (linkExist == false) {
        link.wtsum = link.wt;
        links.push(link);
      }

      update();
      count++;

      console.log("end function addLink");
    }


    /**
     * update graph images.
     */
    function update() {
      console.log("start function update.");

      updateLink();
      updateNode();

      // restart the force layout.
      forceLayout
        .distance(200)
        .charge(-200)
        .linkDistance(200)
        .gravity(0)
        .size([AREA_W, AREA_H])
        .on("tick", tick)
        .start();

      console.log("end function update.");
    }


    /**
     *
     */
    function updateLink() {

      // add link.
      linkObj = svg.select("g.data").selectAll(".link")
        .data(links, function(d) {
          return d.id;
        });

      linkObj.enter()
        .append("path")
        .attr({
          "id": function(d) {
            return d.id;
          },
          "class": "link",
          "marker-end": "url(#arrowhead)"
        });

      // update link.
      linkObj
        .attr({
          "stroke-width": function(d) {
            // console.log(d);
            return LINK_W_DEFAULT + LINK_W_WEIGHT * d.wtsum;
          },
          // "stroke-dasharray": function(d) {
          //   console.log(d);
          //   var totalLength = d.node().getTotalLength();
          //   var t = totalLength - (10 + 10 + 8);
          //   return "0 " + 10 + " " + t + " " + 10;
          // },
          // "stroke-dasharray": 0
        });
    }


    /**
     *
     */
    function updateNode() {
      svg.select("g.data").selectAll(".node")
        .data(nodes, function(d) {
          return d.id;
        })
        .select("circle")
        .attr({
          "class": function(d) {
            var classes;
            if ("boss" in d && d.boss == true) {
              classes = "boss";
            }
            if (d.wtsum > d.limit) {
              classes = classes + " " + "overflow";
            }
            return classes;
          },
          "r": function(d) {
            return NODE_R_DEFAULT + NODE_R_WEIGHT * d.wtsum;
          }
        });
    }

    /**
     * function of force ticks.
     */
    function tick() {
      linkObj.attr("d", function(d) {
        var dx = d.target.x - d.source.x,
          dy = d.target.y - d.source.y,
          dr = Math.sqrt(dx * dx + dy * dy);
        return "M" +
          d.source.x + "," +
          d.source.y + "A" +
          dr + "," + dr + " 0 0,1 " +
          d.target.x + "," +
          d.target.y;
      });

      nodeObj.attr("transform", function(d) {
        return "translate(" + d.x + "," + d.y + ")";
      });
    }
  </script>
</body>

</html>
